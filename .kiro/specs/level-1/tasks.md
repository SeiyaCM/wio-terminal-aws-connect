# 実装計画: IoT AWS Infrastructure

## 概要

産業機器監視システムのためのAWSインフラストラクチャをCDKとPythonで実装する。IoT Core、DynamoDB、Athena、QuickSightを使用したシンプルなデータパイプラインを構築する。

## タスク

- [x] 1. プロジェクト構造とCDK環境のセットアップ
  - infraフォルダの作成とCDKプロジェクトの初期化
  - uvを使用したPython依存関係管理の設定
  - CDKスタック名をwio-terminal-infra-stackに設定
  - _要件: 5.1, 5.2, 5.3, 5.5_

- [-] 1.1 プロパティテスト用のテスト環境セットアップ

  - **プロパティ 5: CDKリソース定義の正確性**
  - **検証: 要件 5.4**

- [x] 2. DynamoDBテーブルの実装
  - パーティションキー: device_id (String)
  - ソートキー: timestamp (Number)
  - 時系列データ用の属性定義
  - _要件: 3.1, 3.4_

- [ ]* 2.1 DynamoDBテーブル作成のプロパティテスト
  - **プロパティ 1: データ処理の完全性**
  - **検証: 要件 3.1**

- [x] 3. IoT Core とIoT Ruleの実装
  - IoT Coreの基本設定
  - MQTTトピック: device/+/data
  - SQL文: SELECT *, timestamp() as received_at FROM 'device/+/data'
  - DynamoDB Put Item Actionの設定
  - _要件: 1.1, 1.4, 2.1, 2.3_

- [ ]* 3.1 IoT Rule動作のプロパティテスト
  - **プロパティ 1: データ処理の完全性**
  - **検証: 要件 1.1, 2.1**

- [ ]* 3.2 エラーハンドリングのプロパティテスト
  - **プロパティ 2: エラーハンドリングの一貫性**
  - **検証: 要件 1.2, 3.2**

- [x] 4. IAMロールと権限の実装
  - IoT RuleからDynamoDBへの書き込み権限
  - 最小権限の原則に従った権限設定
  - _要件: 1.1, 2.3_

- [ ] 5. チェックポイント - 基本データパイプラインの動作確認
  - すべてのテストが通ることを確認し、ユーザーに質問があれば尋ねる

- [x] 6. AWS Glue Crawlerの実装
  - DynamoDBテーブルをターゲットとするCrawler
  - Glue Data Catalogへのメタデータ保存
  - 日次実行スケジュールの設定
  - _要件: 4.1, 4.2_

- [ ]* 6.1 Glue Crawlerメタデータ取得のプロパティテスト
  - **プロパティ 4: データ整合性の保証**
  - **検証: 要件 3.4**

- [x] 7. Athena DynamoDB Connectorの実装
  - Serverless Application RepositoryからConnectorをデプロイ
  - S3バケット（SpillBucket）の作成
  - Athenaデータソースの設定
  - _要件: 4.1, 4.2_

- [ ]* 7.1 Athenaクエリ実行のプロパティテスト
  - **プロパティ 4: データ整合性の保証**
  - **検証: 要件 3.4**

- [x] 8. QuickSightデータソースの実装
  - Athenaをデータソースとする設定
  - 基本的なダッシュボード設定
  - _要件: 4.1, 4.3, 4.4, 4.5_

- [ ]* 8.1 データ妥当性検証のプロパティテスト
  - **プロパティ 3: データ妥当性検証**
  - **検証: 要件 2.4**

- [x] 9. 統合テストとデプロイメント検証
  - CDKデプロイメントの実行
  - エンドツーエンドのデータフロー確認
  - _要件: 5.4_

- [ ]* 9.1 統合テスト
  - IoT Core → IoT Rule → DynamoDB → Athena → QuickSightの完全フロー
  - _要件: 1.1, 2.1, 3.1, 4.1_

- [ ] 10. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、ユーザーに質問があれば尋ねる

## 注記

- `*`マークのタスクはオプションで、より迅速なMVPのためにスキップ可能
- 各タスクは特定の要件を参照し、トレーサビリティを確保
- チェックポイントで段階的な検証を実施
- プロパティテストは設計文書の正確性プロパティを検証
- 単体テストは具体例とエッジケースを検証